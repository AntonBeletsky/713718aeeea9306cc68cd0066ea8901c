(window.webpackJsonppageos=window.webpackJsonppageos||[]).push([[0],{X5Dm:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return h}));var s=i("lwsE"),n=i.n(s),r=i("W8MJ"),a=i.n(r),o=i("YfMo"),h=function(){function e(t){n()(this,e),this.hasStorage=!!window.PageOS.environment&&window.PageOS.environment.hasLocalStorage,this._REGION="us-east-1",this._API_VERSION="2013-12-02",this._creds=t,this.lastBatchSent=Date.now(),this.queue=[],this.batchTimer=null,this.BATCH_SIZE=10,this.BATCH_INTERVAL=5e3,this.maxRetryAttempts=3,this.hasStorage&&localStorage.getItem("PageOS_Kinesis")&&(this.queue=JSON.parse(localStorage.getItem("PageOS_Kinesis"))),this.init()}return a()(e,[{key:"addToQueue",value:function(e){var t=e.records,i=e.streamName,s=e.sampling;if(!this._credsHaveExpired){t=Array.isArray(t)?t:[t];var n=[];t.forEach((function(e){!1!==s&&!1!==e.Sampling||n.push({Data:e.Data,PartitionKey:e.PartitionKey})})),n.length>0&&(this.queue.push({records:n,streamName:i}),this.hasStorage&&localStorage.setItem("PageOS_Kinesis",JSON.stringify(this.queue)),this.isBatchReady())}}},{key:"clearTimer",value:function(){clearTimeout(this.batchTimer),this.batchTimer=null}},{key:"configureAwsKinesis",value:function(){try{window.AWS.config.credentials=new window.AWS.Credentials(this._creds.AccessKeyId,this._creds.SecretAccessKey,this._creds.SessionToken),window.AWS.config.region=this._REGION,this._awsKinesis=new window.AWS.Kinesis({apiVersion:this._API_VERSION}),this._credsExpiration=new Date(window.pwKinesisCreds.Expiration),o.d.info("SUCCESS Kinesis configured")}catch(e){return void o.d.warn("Disabled due to lack of credentials error ðŸ˜¤",e)}}},{key:"getQueueCount",value:function(){var e=0;return this.queue.forEach((function(t){e+=t.records.length})),e}},{key:"init",value:function(){var e=this,t=document.createElement("script");t.src="https://cdn.intergient.com/pageos/js/libs/aws-sdk-kinesis.min.js",document.head.appendChild(t),t.onload=function(){e.configureAwsKinesis()}}},{key:"isBatchReady",value:function(){var e=this;if(!this.queue.length)return!1;this.getQueueCount()>=this.BATCH_SIZE||Date.now()-this.lastBatchSent>this.BATCH_INTERVAL?(this.clearTimer(),this.sendToKinesis()):this.batchTimer||(this.batchTimer=setTimeout((function(){e.sendToKinesis()}),this.BATCH_INTERVAL))}},{key:"sendToKinesis",value:function(){if(this._awsKinesis&&0!==this.queue.length&&!this._credsHaveExpired){var e={};if(Date.now()>=this._credsExpiration)return this._credsHaveExpired=!0,void o.d.error("Kinesis credentials expired.");for(;this.queue.length;){var t=this.queue.shift(),i=t.records,s=t.streamName;Array.isArray(e[s])?e[s]=e[s].concat(i):e[s]=i}for(var n in this.hasStorage&&localStorage.setItem("PageOS_Kinesis",JSON.stringify(this.queue)),e)e[n].length&&this.putRecords(e[n],n);this.lastBatchSent=Date.now()}}},{key:"putRecords",value:function(e,t){var i=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this._awsKinesis.putRecords({Records:e,StreamName:t},(function(n){n&&(o.d.warn("Kinesis Send Error",{err:n,pipeline:t,data:e,retryAttempt:s}),s<i.maxRetryAttempts?i.putRecords(e,t,++s):o.d.error("Kinesis Max Retry Attempts met"))}))}}]),e}()}}]);